<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Institutional Visit Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs" defer></script>
    <style>
        /* Optional: Style for required fields - based on the 'req' class in the HTML */
        .req::after {
            content: ' *';
            color: #ef4444; /* red-500 */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-10">

    <div class="max-w-6xl mx-auto bg-white shadow-lg rounded-lg p-6">

        <div x-data="institutionalVisitForm()" class="w-full max-w-7xl">

            <div class="border-b border-gray-300 mb-6">
                <nav class="flex space-x-6" id="tabs">
                    <button class="py-2 px-4 font-medium text-indigo-600 border-b-2 border-indigo-600" 
                            onclick="showTab(event,'entry')">Institutional Visit</button>
                    <button class="py-2 px-4 font-medium text-gray-600 hover:text-indigo-600" 
                            onclick="showTab(event,'validations')">Validations</button>
                </nav>
            </div>

            <div id="tab-entry" class="tab-content">
                <div class="bg-white shadow-lg rounded-lg w-full p-6">
                    <div class="border-b pb-4 mb-6">
                        <h1 class="text-2xl font-bold text-gray-700">Institutional Visit Master</h1>
                        <p class="text-sm text-gray-500">Define groups, pricing, age groups, and validity</p>
                    </div>

                    <form @submit.prevent="submitForm" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                       
                        <div>
                            <label class="block font-medium mb-1">Product Code</label>
                            <input type="text" x-model="form.name" class="w-full border rounded px-3 py-2" placeholder="Enter Product Code">
                        </div>

					   <div>
                            <label class="block font-medium mb-1">Product Name</label>
                            <input type="text" x-model="form.name" class="w-full border rounded px-3 py-2" placeholder="Enter Product Name Visit">
                        </div>
						
						                        <div>
                            <label class="block font-medium mb-1">Display Name</label>
                            <input type="text" x-model="form.name" class="w-full border rounded px-3 py-2" placeholder="Enter Display Name">
                        </div>
						
					    <div>
							<label class="block font-medium">Description</label>
							<textarea id="planDesc" rows="3" placeholder="Optional description"
							  class="mt-1 w-full border rounded px-3 py-2"></textarea>
						 </div>


                        <div>
                            <label class="block font-medium text-gray-700">Tax Type</label>
                            <select x-model="form.taxType" class="mt-1 block w-full border rounded px-3 py-2">
                                <option value="Inclusive">Inclusive</option>
                                <option value="Exclusive">Exclusive</option>
                            </select>
                        </div>

                        <div>
                            <label class="block font-medium req text-gray-700">Tax %</label>
                            <select x-model.number="form.taxPercent" class="mt-1 block w-full border rounded px-3 py-2">
                                <option value="" disabled>Select Tax %</option>
                                <option value="5">GST 5</option>
                                <option value="12">GST 12</option>
                                <option value="18">GST 18</option>
                            </select>
                            <p class="text-xs text-gray-400 mt-1">Selecting tax will auto-populate HSN code below.</p>
                        </div>

                        <div>
                            <label class="block font-medium text-gray-700">HSN Code (auto)</label>
                            <input type="text" :value="hsnCode" readonly class="mt-1 block w-full border rounded px-3 py-2 bg-gray-50" />
                        </div>

                        <div class="relative">
                            <label class="block font-medium mb-1">Discounts</label>
                            <div @click="openDiscount = !openDiscount" tabindex="0" class="w-full border rounded-md px-3 py-2 flex justify-between items-center text-gray-700 bg-white cursor-pointer">
                                <span x-text="selectedDiscountsText()"></span>
                                <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                </svg>
                            </div>
                            <div x-show="openDiscount" @click.away="openDiscount=false" class="absolute mt-1 w-full bg-white border rounded-md shadow-lg z-10 max-h-60 overflow-y-auto">
                                <div class="p-2 border-b">
                                    <input type="text" x-model="discountSearch" placeholder="Search..." class="w-full px-2 py-1 border rounded text-sm">
                                </div>
                                <div class="max-h-48 overflow-y-auto">
                                    <template x-for="discount in filteredDiscounts" :key="discount">
                                        <label class="flex items-center px-3 py-2 hover:bg-gray-100 cursor-pointer">
                                            <input type="checkbox" :value="discount" x-model="form.discounts" class="h-4 w-4 text-blue-600 rounded">
                                            <span class="ml-2" x-text="discount"></span>
                                        </label>
                                    </template>
                                </div>
                            </div>
                        </div>
						
						<div>
                            <label class="block font-medium text-gray-700">Channels</label>
                            <div class="flex gap-3 mt-2 flex-wrap">
                                <label class="inline-flex items-center gap-2"><input type="checkbox" class="channel" value="Web" checked> Web</label>
                                <label class="inline-flex items-center gap-2"><input type="checkbox" class="channel" value="POS"> POS</label>
                                <label class="inline-flex items-center gap-2"><input type="checkbox" class="channel" value="Kiosk"> Kiosk</label>
                                <label class="inline-flex items-center gap-2"><input type="checkbox" class="channel" value="Website"> Website</label>
                                <label class="inline-flex items-center gap-2"><input type="checkbox" class="channel" value="OTA"> OTA</label>
                            </div>
                        </div>
						


                        <div>
                            <label class="block font-medium text-gray-700">Image (optional)</label>
                            <input id="imageFile" type="file" accept="image/*" class="mt-1 block w-full" />
                            <div id="imgPreview" class="mt-3 hidden">
                                <img id="imgPreviewTag" class="w-44 h-28 object-cover rounded border" alt="preview">
                                <div><button id="removeImage" type="button" class="mt-2 text-xs text-red-600">Remove image</button></div>
                            </div>
                        </div>

                        <div>
                            <label class="block font-medium text-gray-700">Video URL (optional)</label>
                            <input id="videoUrl" type="url" placeholder="https://youtube.com/..."
                                class="mt-1 block w-full border rounded px-3 py-2" />
                        </div>
						
						                        <div class="flex justify-start items-end pt-6">
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" x-model="form.active" class="sr-only peer">
                                <div class="w-14 h-7 bg-red-400 peer-checked:bg-green-500 rounded-full peer relative transition-colors">
                                    <span class="absolute left-1 top-1 w-5 h-5 bg-white rounded-full transition-all peer-checked:translate-x-7"></span>
                                </div>
                                <span class="ml-3 text-gray-700 font-medium">Active</span>
                            </label>
                        </div>

 
                        <section class="lg:col-span-1 space-y-4">
                            <div class="mb-6">
                                <h3 class="text-lg font-semibold mb-2">Select Age Groups</h3>
                                <div class="flex gap-4 flex-wrap">
                                    <label><input type="checkbox" onclick="toggleSelection('age','0-6')"> 0-6</label>
                                    <label><input type="checkbox" onclick="toggleSelection('age','7-10')"> 7-10</label>
                                    <label><input type="checkbox" onclick="toggleSelection('age','11-17')"> 11-17</label>
                                    <label><input type="checkbox" onclick="toggleSelection('age','18+')"> 18+</label>
                                </div>
                            </div>
                            
                            <div class="mb-6">
                                <h3 class="text-lg font-semibold mb-2">Select Visitor Types</h3>
                                <div class="flex gap-4 flex-wrap">
                                    <label><input type="checkbox" onclick="toggleSelection('plan','NGO')"> NGO</label>
                                    <label><input type="checkbox" onclick="toggleSelection('plan','School')"> School</label>
                                    <label><input type="checkbox" onclick="toggleSelection('plan','Corporate')"> Corporate</label>
                                    <label><input type="checkbox" onclick="toggleSelection('plan','Govt School')"> Govt School</label>
                                </div>
                            </div>
							
					
                            
                            <div id="pricingUI" class="mt-6 col-span-full md:col-span-3">
                                <p class="text-gray-500 italic">Select Age Group(s) and Plan(s) to define pricing.</p>
                            </div>
                        </section>


                        <div>
                            <label class="block font-medium mb-1">Allow Booking Before (in Days)</label>
                            <input type="number" x-model.number="form.allowBookingBefore" min="0" class="w-full border rounded px-3 py-2" placeholder="e.g., 7">
                        </div>
                        
                        <div>
                            <label class="block font-medium mb-1">Activation Start Date</label>
                            <input type="date" x-model="form.activationDate" class="w-full border rounded px-3 py-2">
                        </div>
                        <div>
                            <label class="block font-medium mb-1">Activation End Date</label>
                            <input type="date" x-model="form.activationEndDate" class="w-full border rounded px-3 py-2">
                        </div>
						
                        
                        <div>
                            <label class="block font-medium mb-1">Booking Start Date</label>
                            <input type="date" x-model="form.startDate" class="w-full border rounded px-3 py-2">
                        </div>
                        <div>
                            <label class="block font-medium mb-1">Booking End Date</label>
                            <input type="date" x-model="form.endDate" class="w-full border rounded px-3 py-2">
                        </div>
                        

                                              
                                               
						
						<div id="partnershipDiv" class=" col-span-1">
						<label class="block font-medium">Partnership</label>
						<label class="relative inline-flex items-center cursor-pointer mt-1">
						  <input type="checkbox" id="partnershipToggle" class="sr-only peer">
						  <div class="w-14 h-7 bg-red-400 peer-checked:bg-green-500 rounded-full peer relative transition-colors">
							<span class="absolute left-1 top-1 w-5 h-5 bg-white rounded-full transition-all peer-checked:translate-x-7"></span>
						  </div>
						  <span class="ml-3 text-gray-700 font-medium">Active</span>
						</label>
				  </div>

                        
                        <div class="col-span-full flex justify-center space-x-4 mt-8">
                            <button type="submit" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-lg transition-colors">Save</button>
                            <button type="reset" @click="resetForm()" class="px-6 py-2 bg-gray-400 hover:bg-gray-500 text-white font-medium rounded-lg transition-colors">Reset</button>
                            <button type="button" @click.prevent="resetForm()" class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg transition-colors">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
			
			<!-- validations -->

            <div id="tab-validations" class="tab-content hidden">
                <h2 class="text-xl font-bold mb-6 text-gray-700">Age Group & Guardian Matrix</h2>

                <form id="ageGroupForm" class="space-y-6">
                    <table class="w-full border border-gray-300 rounded-lg overflow-hidden">
                        <thead class="bg-indigo-600 text-white">
                            <tr>
                                <th class="px-4 py-3 text-left">Age Group</th>
                                <th class="px-4 py-3 text-left">No. of Persons (&lt; or $\gt$ allowed)</th>
                                <th class="px-4 py-3 text-left">Required (18+ & Free Ticket)</th>
                                <th class="px-4 py-3 text-center">Extra Free Tickets</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            <tr>
                                <td class="px-4 py-3">3 – 6 years</td>
                                <td><input type="text" id="age0_6" placeholder="e.g. <5 or 10" class="w-28 border rounded p-1"></td>
                                <td class="px-4 py-3 flex items-center gap-2">
                                    <span class="px-2 py-1 text-sm bg-gray-100 border rounded">18+</span>
                                    <input type="number" id="req0_6" min="0" value="0" class="w-16 border rounded p-1">
                                </td>
                                <td class="px-4 py-3 text-center"><input type="number" value="0" class="w-16 border rounded p-1"></td>
                            </tr>
                            <tr>
                                <td class="px-4 py-3">7 – 10 years</td>
                                <td><input type="text" id="age7_10" placeholder="e.g. $\gt$3 or 8" class="w-28 border rounded p-1"></td>
                                <td class="px-4 py-3 flex items-center gap-2">
                                    <span class="px-2 py-1 text-sm bg-gray-100 border rounded">18+</span>
                                    <input type="number" id="req7_10" min="0" value="0" class="w-16 border rounded p-1">
                                </td>
                                <td class="px-4 py-3 text-center"><input type="Number" value="0" class="w-16 border rounded p-1"></td>
                            </tr>
                            <tr>
                                <td class="px-4 py-3">11 – 17 years</td>
                                <td><input type="text" id="age11_17" placeholder="e.g. <12" class="w-28 border rounded p-1"></td>
                                <td class="px-4 py-3 flex items-center gap-2">
                                    <span class="px-2 py-1 text-sm bg-gray-100 border rounded">18+</span>
                                    <input type="number" id="req11_17" min="0" value="0" class="w-16 border rounded p-1">
                                </td>
                                <td class="px-4 py-3 text-center"><input type="Number" value="0" class="w-16 border rounded p-1"></td>
                            </tr>
                        </tbody>
                    </table>

                    <div id="validationMsg" class="text-red-600 font-medium"></div>

                    <div class="mt-6 flex items-center gap-3">
                        <button type="button" id="btnCancel" class="px-4 py-2 rounded-lg bg-gray-500 hover:bg-gray-600 text-white font-medium">Cancel</button>
                        <button type="reset" class="px-4 py-2 rounded-lg bg-red-500 hover:bg-red-600 text-white font-medium">Reset</button>
                        <button type="button" id="btnSave" class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-medium">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

<script>
    // Tab switcher
    function showTab(event, tab) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        document.getElementById('tab-' + tab).classList.remove('hidden');
        document.querySelectorAll('#tabs button').forEach(btn => btn.classList.remove('text-indigo-600','border-b-2','border-indigo-600'));
        event.currentTarget.classList.add('text-indigo-600','border-b-2','border-indigo-600');
    }

    // Alpine.js form data and logic
    function institutionalVisitForm() {
        return {
            form: {
                name: '',
                taxType: 'Inclusive',
                taxPercent: null,
                allowBookingBefore: 0,
                activationDate: '',
                activationEndDate: '',
                startDate: '',
                endDate: '',
                ageGroups: [],
                discounts: [],
                channels: [],
                active: true // Setting initial state to true for the active toggle
            },
            // groups: [ ... ], // Removed groups as they are now 'plans' and handled by custom JS
            ageGroups: ['0-6', '7-10', '11-17'],
            openDiscount: false,
            discountSearch: '',

            // Computed property for HSN Code
            get hsnCode() {
                switch(this.form.taxPercent){
                    case 5: return 'HSN05';
                    case 12: return 'HSN12';
                    case 18: return 'HSN18';
                    default: return '';
                }
            },

            // Computed property for filtering discounts
            get filteredDiscounts() {
                // Hardcoded discount list, filtered by search term
                return ['Early Bird','Dharohar','Group'].filter(d => d.toLowerCase().includes(this.discountSearch.toLowerCase()));
            },

            // Display text for selected discounts
            selectedDiscountsText() {
                return this.form.discounts.length ? this.form.discounts.join(', ') : 'Select Discounts';
            },

            // Reset logic
            resetForm() {
                this.form = {
                    name: '',
                    taxType: 'Inclusive',
                    taxPercent: null,
                    allowBookingBefore: 0,
                    activationDate: '',
                    activationEndDate: '',
                    startDate: '',
                    endDate: '',
                    ageGroups: [],
                    discounts: [],
                    channels: [],
                    active: true
                };
                // Reset custom JS selection logic too
                selectedAges = [];
                selectedPlans = [];
                buildPricingUI();
                
                // Uncheck all age/plan checkboxes
                document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    if (checkbox.onclick && checkbox.onclick.toString().includes('toggleSelection')) {
                        checkbox.checked = false;
                    }
                });
            },

            // Submission logic
            submitForm() {
                // Logic to gather prices from the dynamically generated table
                const pricingMatrix = {};
                document.querySelectorAll('.priceInput').forEach(input => {
                    const age = input.getAttribute('data-age');
                    const plan = input.getAttribute('data-plan');
                    const activeCheckbox = document.querySelector(`.activeToggle[data-age="${age}"][data-plan="${plan}"]`);
                    
                    if (input.value && activeCheckbox && activeCheckbox.checked) {
                        if (!pricingMatrix[age]) pricingMatrix[age] = {};
                        pricingMatrix[age][plan] = parseFloat(input.value);
                    }
                });
                
                // Gather channels
                const channels = Array.from(document.querySelectorAll('.channel:checked')).map(c => c.value);
                this.form.channels = channels;
                
                const finalForm = {
                    ...this.form,
                    pricing: pricingMatrix
                };
                
                alert('Form submitted. Check console for full data.');
                console.log('Final Form Data:', finalForm);
            }
        }
    }
</script>

<script>
    // --- Custom JavaScript for Pricing Matrix ---
    let selectedAges = [];
    let selectedPlans = [];

    // Selection toggles
    function toggleSelection(type, value) {
        if (type === 'age') {
            selectedAges = toggleArray(selectedAges, value);
        } else {
            selectedPlans = toggleArray(selectedPlans, value);
        }
        buildPricingUI();
    }
    
    // Helper to add or remove a value from an array
    function toggleArray(arr, val) {
        return arr.includes(val) ? arr.filter(v => v !== val) : [...arr, val];
    }

    // Pricing matrix rendering
    function buildPricingUI() {
        const wrap = document.getElementById('pricingUI');
        wrap.innerHTML = '';
        
        if (!selectedAges.length || !selectedPlans.length) {
            wrap.innerHTML = `<p class="text-gray-500 italic">Select Age Group(s) and Plan(s) to define pricing.</p>`;
            return;
        }
        
        const table = document.createElement('table');
        table.className = 'w-full border text-sm shadow-md';
        
        // Table Header
        const thead = document.createElement('thead');
        thead.className = 'bg-gray-50';
        thead.innerHTML = `<tr><th class="border px-2 py-2 font-semibold text-left">Age \\ Plan</th>${selectedPlans.map(p=>`<th class="border px-2 py-2 font-semibold">${p}</th>`).join('')}</tr>`;
        table.appendChild(thead);
        
        // Table Body
        const tbody = document.createElement('tbody');
        selectedAges.forEach(a => {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50';
            tr.innerHTML = `<td class="border px-2 py-3 font-medium bg-gray-100">${a}</td>` +
                selectedPlans.map(p=>`
                    <td class="border px-2 py-3 text-center">
                        <input type="number" min="0" class="priceInput w-20 border rounded px-1 py-1 text-center mb-2 focus:ring-indigo-500 focus:border-indigo-500" data-age="${a}" data-plan="${p}" placeholder="₹ Price">
                        <label class="text-xs flex items-center justify-center gap-1">
                            <input type="checkbox" class="activeToggle text-indigo-600 rounded" data-age="${a}" data-plan="${p}" checked> Active
                        </label>
                    </td>`).join('');
            tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        wrap.appendChild(table);
    }
    
    // Initial call to set up the default state
    document.addEventListener('DOMContentLoaded', () => {
        showTab({ currentTarget: document.querySelector('#tabs button:first-child') }, 'entry');
        buildPricingUI();
    });

</script>

</body>
</html>